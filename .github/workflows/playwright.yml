name: Playwright Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  run-tests:
    name: Run Playwright Test Suite
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Create .env file
        run: |
          echo "USERNAME_TALENT=${{ secrets.USERNAME_TALENT }}" >> .env
          echo "USERNAME_SALES=${{ secrets.USERNAME_SALES }}" >> .env
          echo "OTP=${{ secrets.OTP }}" >> .env
          echo "URL=${{ vars.URL }}" >> .env

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers & deps
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true

      - name: Commit and push screenshots and reports
        if: ${{ !cancelled() }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          DATE=$(date +'%Y-%m-%d')
          
          git add -f screenshots/daily/${DATE}/
          git add -f reports/results-${DATE}.json
          git add -f reports/summary-${DATE}.html
          git add -f screenshots/diffs/
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "ü§ñ Automated: Screenshots and reports for ${DATE} [Run #${{ github.run_number }}]

            üì∏ Screenshots: screenshots/daily/${DATE}/
            üìä Reports: reports/summary-${DATE}.html
            
            Generated by GitHub Actions Run #${{ github.run_number }}
            Commit: ${{ github.sha }}"
            
            git push
            echo "‚úÖ Successfully pushed screenshots and reports to main branch"
          fi

      - name: Upload Custom Hybrid Reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: hybrid-reports
          path: reports/
          retention-days: 30

      - name: Upload Playwright Built-in Report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Set report folder name
        id: vars
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "RUN_FOLDER=$(date +'%Y-%m-%d')-Run-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Prepare combined reports for GitHub Pages
        if: ${{ !cancelled() }}
        run: |
          mkdir -p gh-pages-deploy
          
          if [ -d "reports" ]; then
            cp -r reports gh-pages-deploy/custom-reports
            echo "‚úÖ Custom reports copied"
          else
            echo "‚ö†Ô∏è No custom reports folder found"
            mkdir -p gh-pages-deploy/custom-reports
          fi
          
          if [ -d "playwright-report" ]; then
            cp -r playwright-report gh-pages-deploy/playwright-report
            echo "‚úÖ Playwright report copied"
          else
            echo "‚ö†Ô∏è No playwright-report folder found"
            mkdir -p gh-pages-deploy/playwright-report
          fi
          
          cat > gh-pages-deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>UI Visual Check Reports - Run ${{ github.run_number }}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; background: #f5f5f5; }
              .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
              h1 { color: #333; }
              .report-section { margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 6px; }
              .report-link { display: inline-block; margin: 10px; padding: 15px 25px; background: #2196f3; color: white; text-decoration: none; border-radius: 4px; font-weight: bold; }
              .report-link:hover { background: #1976d2; }
              .info { color: #666; font-size: 14px; margin-top: 10px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üé® UI Visual Check Reports</h1>
              <p><strong>Run #${{ github.run_number }}</strong> ‚Ä¢ Generated on ${{ steps.vars.outputs.DATE }}</p>
              
              <div class="report-section">
                <h2>üìä Custom Hybrid Reports (Recommended)</h2>
                <p>Interactive reports with layout analysis, visual comparison, and detailed breakdowns.</p>
                <a href="./custom-reports/summary-${{ steps.vars.outputs.DATE }}.html" class="report-link">üìà View Hybrid Report</a>
                <div class="info">‚ú® Features: Layout scoring, element tracking, visual diffs, filterable results</div>
              </div>
              
              <div class="report-section">
                <h2>üé≠ Playwright Built-in Report</h2>
                <p>Standard Playwright test execution report with step-by-step details.</p>
                <a href="./playwright-report/index.html" class="report-link">üîç View Playwright Report</a>
                <div class="info">üìã Features: Test steps, traces, screenshots on failure</div>
              </div>
            </div>
          </body>
          </html>
          EOF
          
          echo "üìÅ Deployment folder structure:"
          ls -la gh-pages-deploy/
          echo "üìä Custom reports:"
          ls -la gh-pages-deploy/custom-reports/ || echo "Empty"
          echo "üé≠ Playwright report:"
          ls -la gh-pages-deploy/playwright-report/ || echo "Empty"

      - name: Publish reports to GitHub Pages
        if: ${{ !cancelled() }}
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: gh-pages-deploy
          target-folder: ${{ steps.vars.outputs.RUN_FOLDER }}
          clean: false
          single-commit: true

      - name: Send results to Microsoft Teams
        if: ${{ !cancelled() }}
        run: |
          STATUS="‚úÖ Success"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="‚ùå Failed"
          fi

          REPO_NAME="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          RUN_NUM="${{ github.run_number }}"
          DATE="${{ steps.vars.outputs.DATE }}"
          
          HYBRID_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.vars.outputs.RUN_FOLDER }}/custom-reports/summary-${DATE}.html"
          PLAYWRIGHT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.vars.outputs.RUN_FOLDER }}/playwright-report/index.html"
          MAIN_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.vars.outputs.RUN_FOLDER }}/"

          curl -X POST "${{ secrets.TEAMS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "summary": "UI Visual Check - Run #${RUN_NUM}",
            "themeColor": "$( [ \"${STATUS}\" = \"‚úÖ Success\" ] && echo \"28a745\" || echo \"dc3545\" )",
            "title": "üé® UI Visual Check - Run #${RUN_NUM}",
            "sections": [
              {
                "facts": [
                  { "name": "Status:", "value": "${STATUS}" },
                  { "name": "Repository:", "value": "${REPO_NAME}" },
                  { "name": "Branch:", "value": "${BRANCH}" },
                  { "name": "Date:", "value": "${DATE}" }
                ]
              }
            ],
            "potentialAction": [
              {
                "@type": "OpenUri",
                "name": "üé® View Hybrid Report",
                "targets": [{ "os": "default", "uri": "${HYBRID_URL}" }]
              },
              {
                "@type": "OpenUri",
                "name": "üé≠ View Playwright Report",
                "targets": [{ "os": "default", "uri": "${PLAYWRIGHT_URL}" }]
              },
              {
                "@type": "OpenUri",
                "name": "üìÇ All Reports",
                "targets": [{ "os": "default", "uri": "${MAIN_URL}" }]
              }
            ]
          }
          EOF


